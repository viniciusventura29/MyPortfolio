---
import { getCollection } from "astro:content";
import Layout from "../../../layouts/MainLayout.astro";
import { useTranslations, languages, type Locale } from "../../../i18n/utils";

export function getStaticPaths() {
  return Object.keys(languages).map((lang) => ({
    params: { lang },
  }));
}

const lang = Astro.params.lang as Locale;
const t = useTranslations(lang);

const posts = await getCollection("blog");
// Filter posts by language folder (en/ or pt/)
const langPosts = posts.filter((post) => post.slug.startsWith(`${lang}/`));
const publishedPosts = langPosts
  .filter((post) => post.data.draft !== true)
  .sort((a, b) => new Date(b.data.publishDate).getTime() - new Date(a.data.publishDate).getTime());

// Helper to get slug without language prefix
function getPostSlug(fullSlug: string): string {
  return fullSlug.replace(`${lang}/`, '');
}
---

<Layout title="Blog - Vinicius Ventura" lang={lang}>
  <main class="main-content">
    <!-- Header -->
    <header class="page-header">
      <div class="header-top">
        <span class="header-label">{t.blogPage.archive}</span>
        <span class="header-count">{publishedPosts.length} {t.blogPage.entries}</span>
      </div>
      <h1 class="page-title">{t.blogPage.title}</h1>
      <p class="page-description">
        {t.blogPage.description}
      </p>
      <div class="header-border">
        <span class="border-text">{t.blogPage.chronological}</span>
        <span class="border-line"></span>
      </div>
    </header>

    <!-- Blog List -->
    <div class="blog-list">
      {publishedPosts.map((post, index) => (
        <a href={`/${lang}/blog/${getPostSlug(post.slug)}`} class="blog-card">
          <div class="card-sidebar">
            <span class="card-number">{String(index + 1).padStart(3, '0')}</span>
          </div>
          
          <div class="card-content">
            <div class="card-header">
              <span class="card-label">{t.blogPage.entry}</span>
              <span class="card-date">{post.data.publishDate}</span>
            </div>
            
            {post.data.image && (
              <div class="card-image-container">
                <img
                  src={post.data.image}
                  alt=""
                  class="card-image"
                  transition:name={post.data.image}
                />
                <span class="image-label">{t.blogPage.attachment}</span>
              </div>
            )}
            
            <h2 
              class="card-title"
              transition:name={`title-${post.data.title}`}
            >
              {post.data.title}
            </h2>
            
            <p class="card-description">
              {post.data.description}
            </p>
            
            <div class="card-footer">
              <span class="card-time">{post.data.time} {t.blogPage.minRead}</span>
              <span class="card-action">{t.blogPage.openFile}</span>
            </div>
          </div>
        </a>
      ))}
    </div>

    {publishedPosts.length === 0 && (
      <div class="empty-state">
        <span class="empty-icon">â—¯</span>
        <p class="empty-text">{t.blogPage.noEntries}</p>
        <p class="empty-subtext">{t.blogPage.emptyArchive}</p>
      </div>
    )}
  </main>
</Layout>

<style>
  .main-content {
    padding-top: 2rem;
  }

  /* Header */
  .page-header {
    margin-bottom: 3rem;
  }

  .header-top {
    display: flex;
    justify-content: space-between;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6rem;
    color: #5A5A5A;
    letter-spacing: 0.15em;
    margin-bottom: 1rem;
  }

  .page-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.75rem;
    font-weight: 500;
    color: #1A1A1A;
    letter-spacing: 0.15em;
    margin: 0 0 0.75rem 0;
  }

  .page-description {
    font-size: 0.9rem;
    color: #5A5A5A;
    margin: 0 0 1.5rem 0;
  }

  .header-border {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.55rem;
    color: #5A5A5A;
    letter-spacing: 0.15em;
  }

  .border-line {
    flex: 1;
    height: 1px;
    background: linear-gradient(to right, #2D3D3F, transparent);
  }

  /* Blog List */
  .blog-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .blog-card {
    display: flex;
    border: 1px solid #2D3D3F;
    background: #F5F2ED;
    text-decoration: none;
    transition: all 0.2s ease;
  }

  .blog-card:hover {
    border-color: #0D5C4B;
    box-shadow: 4px 4px 0 rgba(13, 92, 75, 0.1);
    transform: translate(-2px, -2px);
  }

  .card-sidebar {
    display: flex;
    align-items: flex-start;
    justify-content: center;
    padding: 1rem 0.75rem;
    background: rgba(13, 92, 75, 0.05);
    border-right: 1px solid #2D3D3F;
  }

  .card-number {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.7rem;
    color: #0D5C4B;
    letter-spacing: 0.1em;
    writing-mode: vertical-lr;
    transform: rotate(180deg);
  }

  .card-content {
    flex: 1;
    padding: 1rem 1.25rem;
  }

  .card-header {
    display: flex;
    justify-content: space-between;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.55rem;
    color: #5A5A5A;
    letter-spacing: 0.15em;
    margin-bottom: 0.75rem;
  }

  .card-image-container {
    position: relative;
    margin-bottom: 1rem;
  }

  .card-image {
    width: 100%;
    height: 200px;
    object-fit: cover;
    object-position: center;
    border: 1px solid #2D3D3F;
    filter: grayscale(20%);
    transition: filter 0.3s ease;
  }

  .blog-card:hover .card-image {
    filter: grayscale(0%);
  }

  .image-label {
    position: absolute;
    bottom: -8px;
    left: 50%;
    transform: translateX(-50%);
    background: #F5F2ED;
    padding: 0 0.5rem;
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.5rem;
    color: #5A5A5A;
    letter-spacing: 0.15em;
    z-index: 1;
  }

  .card-title {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 1.1rem;
    font-weight: 500;
    color: #1A1A1A;
    letter-spacing: 0.05em;
    margin: 0 0 0.5rem 0;
    text-transform: uppercase;
    line-height: 1.3;
  }

  .card-description {
    font-size: 0.85rem;
    color: #5A5A5A;
    line-height: 1.6;
    margin: 0 0 1rem 0;
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .card-footer {
    display: flex;
    justify-content: space-between;
    padding-top: 0.75rem;
    border-top: 1px dashed rgba(45, 61, 63, 0.3);
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.6rem;
    letter-spacing: 0.1em;
  }

  .card-time {
    color: #5A5A5A;
  }

  .card-action {
    color: #0D5C4B;
    transition: opacity 0.2s ease;
  }

  .blog-card:hover .card-action {
    opacity: 0.7;
  }

  /* Empty State */
  .empty-state {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem 2rem;
    border: 1px dashed #2D3D3F;
    text-align: center;
  }

  .empty-icon {
    font-size: 2rem;
    color: #5A5A5A;
    margin-bottom: 1rem;
  }

  .empty-text {
    font-family: 'IBM Plex Mono', monospace;
    font-size: 0.9rem;
    color: #5A5A5A;
    letter-spacing: 0.15em;
    margin: 0 0 0.5rem 0;
  }

  .empty-subtext {
    font-size: 0.8rem;
    color: #8A8A8A;
    margin: 0;
  }

  @media (max-width: 768px) {
    .blog-card {
      flex-direction: column;
    }

    .card-sidebar {
      border-right: none;
      border-bottom: 1px solid #2D3D3F;
      padding: 0.5rem 1rem;
    }

    .card-number {
      writing-mode: horizontal-tb;
      transform: none;
    }

    .card-image {
      height: 140px;
    }
  }
</style>
